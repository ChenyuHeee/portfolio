name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  schedule:
    # Runs daily at 03:30 China Standard Time (19:30 UTC)
    - cron: '30 19 * * *'
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - uses: actions/github-script@v7
        id: check
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const workflow_id = 'deploy.yml'
            const branch = 'main'
            const headSha = context.sha

            const { data } = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              branch,
              status: 'completed',
              per_page: 30
            })

            const lastSuccess = data.workflow_runs.find((r) => r.conclusion === 'success')
            const lastSuccessSha = lastSuccess?.head_sha ?? null

            core.info(`headSha=${headSha}`)
            core.info(`lastSuccessSha=${lastSuccessSha}`)

            const shouldDeploy = !lastSuccessSha || lastSuccessSha !== headSha
            core.setOutput('should_deploy', shouldDeploy ? 'true' : 'false')

  build:
    needs: precheck
    if: needs.precheck.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/configure-pages@v5
      - run: npm install
      - run: npm run build
      - uses: actions/upload-pages-artifact@v3
        with:
          path: .vitepress/dist

  deploy:
    needs: [precheck, build]
    if: needs.precheck.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/deploy-pages@v4
